# DreamUp QA Test Results Viewer

A simple Next.js web viewer for displaying test results and screenshots from the DreamUp QA Pipeline.

## Features

- **Run Tests**: Enter a game URL to run a test directly from the web interface
- **Test List**: View all test runs grouped by game
- **Screenshot Gallery**: Browse screenshots captured during tests
- **Console Logs**: View browser console output
- **Test Details**: See metadata, timestamps, and test information
- **Download Artifacts**: Download individual screenshots and console logs

## Local Development

### Prerequisites

- Node.js 18+
- Test results in `../test-results/` directory (generated by the QA agent)

### Running Locally

```bash
# Install dependencies
npm install

# Run development server
npm run dev
```

The viewer will be available at `http://localhost:3000`

In development mode, the viewer reads test results directly from the `../test-results/` directory via API routes.

## Deployment

### Railway (Recommended)

Railway is **recommended** for this application because:
- ✅ **No strict timeout limits** - Tests can run for the full 5 minutes
- ✅ **Better for long-running processes** - Perfect for browser automation
- ✅ **Hobby plan friendly** - 40-minute build timeout (vs Vercel's 10 seconds)
- ✅ **Full Node.js environment** - All dependencies work as expected
- ✅ **Uses Railpack automatically** - Zero-config deployment (Railway uses [Railpack](https://railpack.com) automatically to analyze and build your app)

#### Railway Deployment Steps

1. **Install Railway CLI** (optional, can also use web UI):
   ```bash
   npm i -g @railway/cli
   railway login
   ```

2. **Deploy from project root**:
   ```bash
   cd /path/to/dreamup-qa
   railway init
   railway up
   ```

3. **Configure Railway**:
   - Set **Root Directory** to `viewer` in Railway dashboard (or use `railway.json`)
   - Add environment variables:
     - `BROWSERBASE_API_KEY` (required)
     - `OPENAI_API_KEY` (required, or your LLM API key)
     - `NEXT_PUBLIC_RAILWAY_ENVIRONMENT=1` (optional, for UI indication)

4. **Deploy**:
   ```bash
   railway up
   ```

The application will automatically detect Railway environment and use **5-minute timeout** for tests.

**Important**: Make sure to deploy from the **project root** (not from the `viewer/` directory) so that Railway has access to the `src/` directory for the test runner API.

Railway uses **Railpack** (zero-config builder) automatically - no additional configuration needed!

### Vercel (Alternative)

#### Automatic Deployment

1. Push your code to GitHub
2. Import the project in Vercel
3. Set the root directory to `viewer`
4. **Important**: For the test runner to work, you need to include the `src/` directory in the deployment
   - Option 1: Deploy from the project root and set root directory to `viewer` (Vercel will still have access to parent files)
   - Option 2: Copy `src/` into `viewer/` before deployment
   - Option 3: Use a monorepo structure

5. Deploy

The `prebuild` script will automatically copy test results to the `public/` directory before building.

#### Vercel Timeout Limitations

**Important**: Vercel serverless functions have timeout limits:
- **Hobby**: 10 seconds
- **Pro**: 60 seconds  
- **Enterprise**: 300 seconds (5 minutes)

The web test runner uses a **60-second timeout by default** to work within Pro plan limits. For longer tests, **use Railway instead** or use the CLI tool directly.

Tests that exceed the timeout will return an error. The test may still complete in the background, but the API response will timeout.

**Note**: Vercel is not recommended for this use case due to timeout limitations. Railway is the better choice.

### Manual Build

```bash
# Copy test results to public directory
npm run prebuild

# Build the Next.js app
npm run build

# Start production server
npm start
```

## How It Works

### Development Mode

- API routes (`/api/tests/*`) read directly from `../test-results/` directory
- Screenshots are served via API routes (`/api/screenshots/*`)
- No need to copy files manually

### Production Mode (Railway/Vercel)

- Test results are copied to `public/test-results/` during build
- Static files are served directly from the public directory
- API routes fall back to public directory if needed

## Project Structure

```
viewer/
├── app/
│   ├── api/
│   │   ├── tests/              # API routes for test data
│   │   ├── test/               # API route to run tests
│   │   └── screenshots/        # API routes for serving images
│   ├── components/
│   │   └── test-form.tsx       # Test input form
│   ├── test/
│   │   └── [gameId]/
│   │       └── [timestamp]/     # Test detail pages
│   ├── layout.tsx              # Root layout
│   └── page.tsx                # Home page (test list)
├── public/                     # Static files (test-results copied here for deployment)
├── scripts/
│   └── copy-test-results.js   # Pre-build script
└── package.json
```

## API Routes

### `GET /api/tests`

Returns a list of all test runs.

**Response:**
```json
{
  "tests": [
    {
      "gameId": "examplecom-25b884ce",
      "timestamp": "2025-11-06T03:30:51.227Z",
      "gameUrl": "https://example.com/game",
      "testId": "909257f4-fe40-43ae-8b3e-45358397712b",
      "screenshotCount": 4,
      "hasConsoleLogs": true,
      "totalDuration": 22901,
      "testStartTime": 1762399851227
    }
  ]
}
```

### `GET /api/tests/[gameId]/[timestamp]`

Returns detailed information about a specific test run.

**Response:**
```json
{
  "manifest": {
    "gameId": "...",
    "testId": "...",
    "timestamp": "...",
    "gameUrl": "...",
    "screenshots": [...],
    "consoleLogs": [...],
    "testStartTime": 1234567890,
    "testEndTime": 1234567891,
    "totalDuration": 1000
  },
  "consoleLog": "..."
}
```

### `POST /api/test`

Runs a new test for a given game URL.

**Request:**
```json
{
  "gameUrl": "https://example.com/game",
  "timeout": 60000  // Optional, defaults to 60 seconds (Vercel) or 300 seconds (Railway)
}
```

**Response:**
```json
{
  "success": true,
  "result": {
    "status": "pass",
    "gameUrl": "https://example.com/game",
    "playability_score": 85,
    "confidence": 90,
    "timestamp": "2025-11-06T03:30:51.227Z",
    "execution_time_ms": 45000,
    "issues": [],
    "screenshots": ["path/to/screenshot.png"],
    "console_logs": "path/to/console.log",
    "metadata": {...}
  },
  "message": "Test completed successfully"
}
```

**Error Response:**
```json
{
  "error": "Test timeout",
  "message": "The test exceeded the timeout limit...",
  "details": "..."
}
```

## Notes

- The viewer is a separate component from the CLI tool
- Test results are generated by the QA agent and stored in `test-results/`
- The viewer reads from these results but doesn't modify them
- For deployment, test results must be included in the repository or copied during build
- **Web Test Runner**: You can run tests directly from the web interface
  - **Railway**: Uses 5-minute timeout (recommended)
  - **Vercel**: Uses 60-second timeout (limited by plan)
- For production use with longer tests, Railway is recommended over Vercel
